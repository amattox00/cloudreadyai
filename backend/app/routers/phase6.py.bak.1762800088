from fastapi import APIRouter, HTTPException, Query
from pydantic import BaseModel
from typing import List, Optional
from rq import Queue
from rq.job import Job

from app.utils.rq_conn import get_redis
from app.modules.phase6 import tasks

router = APIRouter(prefix="/v1/refresh", tags=["phase6"])

class RefreshReq(BaseModel):
    providers: List[str]
    regions: List[str]
    services: List[str]

@router.post("/prices")
def start_refresh(req: RefreshReq):
    """Enqueue a refresh job that warms Phase-5 prices cache."""
    q = Queue(connection=get_redis())
    job: Job = q.enqueue(
        tasks.refresh_prices,
        req.providers,
        req.regions,
        req.services,
        job_timeout=120,   # keep modest; task itself limits timeouts
        result_ttl=600,
        ttl=600
    )
    return {"job_id": job.id}

@router.get("/status")
def refresh_status(job_id: str = Query(..., description="RQ job id")):
    """Check job state/result."""
    q = Queue(connection=get_redis())
    job = q.fetch_job(job_id)
    if not job:
        raise HTTPException(status_code=404, detail="job not found")
    return {
        "id": job.id,
        "state": job.get_status(),
        "enqueued_at": str(job.enqueued_at) if job.enqueued_at else None,
        "started_at": str(job.started_at) if job.started_at else None,
        "ended_at": str(job.ended_at) if job.ended_at else None,
        "result": job.result if job.is_finished else None,
    }
